{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Description" : "create dynamodb demo environment",

    "Parameters" : {
        "KeyName" : {
            "Type" : "String",
            "Description" : "key pair for all ec2 instances"
        },
        "ResourceLink" : {
            "Type" : "String",
            "Description" : "the zip file for all source code and data"
        },
        "ReadCapacityUnits" : {
            "Type" : "Number",
            "Default" : "2000",
            "Description" : "dynamodb read capacity"
        },
        "WriteCapacityUnits" : {
            "Type" : "Number",
			"Default" : "2000",
            "Description" : "dynamodb write capacity"
        },
        "ServerInstanceType" : {
            "Type" : "String",
            "Default" : "m3.2xlarge",
            "Description" : "server instance type"
        },
        "ClientInstanceType" : {
            "Type" : "String",
            "Default" : "m3.large",
            "Description" : "client instance type"
        },
        "ServerInstanceNumber" : {
            "Type" : "Number",
            "Default" : "8",
            "Description" : "server instance number"
        },
        "ClientInstanceNumber" : {
            "Type" : "Number",
            "Default" : "8",
            "Description" : "client instance number"
        },
        "ManagerInstanceType" : {
            "Type" : "String",
            "Default" : "m1.small",
            "Description" : "manager instance type"
        }
    },

    "Mappings" : {
        "Region2Ami" : {
            "ap-northeast-1" : { "AMI" : "ami-c9562fc8" }
        }
    },

    "Resources" : {
        "DynamoDB" : {
            "Type" : "AWS::DynamoDB::Table",
            "Properties" : {
                "KeySchema" : {
                    "HashKeyElement" : {
                        "AttributeName" : "name",
                        "AttributeType" : "S"
                    },
                    "RangeKeyElement" : {
                        "AttributeName" : "date",
                        "AttributeType" : "S"
                    }
                },
                "ProvisionedThroughput" : {
                    "ReadCapacityUnits" : { "Ref" : "ReadCapacityUnits" },
                    "WriteCapacityUnits" : { "Ref" : "WriteCapacityUnits" }
                }
            }
        },

        "InstanceSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "security group for all instances",
                "SecurityGroupIngress" : [
                    {
                        "IpProtocol" :  "tcp",
                        "FromPort" : "80",
                        "ToPort" : "80",
                        "CidrIp" : "0.0.0.0/0"
                    },
                    {
                        "IpProtocol" : "tcp",
                        "FromPort" : "22",
                        "ToPort" : "22",
                        "CidrIp" : "0.0.0.0/0"
                    }
                ]
            }
        },

        "InstanceRole" : {
            "Type" : "AWS::IAM::Role",
            "Properties" : {
                "AssumeRolePolicyDocument" : {
                    "Statement" : [ {
                        "Effect" : "Allow",
                        "Principal" : {
                            "Service" : [ "ec2.amazonaws.com" ]
                        },
                        "Action" : [ "sts:AssumeRole" ]
                    } ]
                },
                "Path" : "/",
                "Policies" : [ {
                    "PolicyName" : "ServerPolicy",
                    "PolicyDocument" : {
                        "Statement" : [
                            {
                                "Effect" : "Allow",
                                "Action" : "dynamodb:*",
                                "Resource" : { "Fn::Join" : [ "", [
                                    "arn:aws:dynamodb:",
                                    { "Ref" : "AWS::Region" },
                                    ":*:table/",
                                    { "Ref" : "DynamoDB" }
                                ] ] }
                            },
                            {
                                "Effect" : "Allow",
                                "Action" : "dynamodb:*",
                                "Resource" : { "Fn::Join" : [ "", [
                                    "arn:aws:dynamodb:",
                                    { "Ref" : "AWS::Region" },
                                    ":*:table/",
                                    { "Ref" : "DynamoDB" },
                                    "/*"
                                ] ] }
                            }
                        ]
                    }
                }]
            }
        },

        "InstanceProfile" : {
            "Type" : "AWS::IAM::InstanceProfile",
            "Properties" : {
                "Path" : "/",
                "Roles" : [ {
                    "Ref" : "InstanceRole"
                } ]
            }
        },

        "ServerLaunchConfiguration" : {
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "Properties" : {
                "KeyName" : { "Ref" : "KeyName" },
				"ImageId" : { "Fn::FindInMap" : [ "Region2Ami", { "Ref" : "AWS::Region" }, "AMI" ] },
                "SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
                "InstanceType" : { "Ref" : "ServerInstanceType"},
                "InstanceMonitoring" : "false",
                "IamInstanceProfile" : { "Ref" : "InstanceProfile" },
                "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
                    "#!/bin/bash", "\n",
                    "yum update -y\n",
                    "# Helper function\n",
                    "function error_exit\n",
                    "{\n",
                    "  /opt/aws/bin/cfn-signal -e 1 -r \"$1\" '", { "Ref" : "ServerWaitHandle" }, "'\n",
                    "  exit 1\n",
                    "}\n",
                    "cd /opt\n",
                    "wget ",
                    " ", { "Ref" : "ResourceLink" },
                    " 2>&1\n",
                    "filename=$(basename ", { "Ref" : "ResourceLink" }, ")\n",
                    "unzip $filename\n",
                    "cd ${filename%.*}\n",
                    "result=`./server_setup.sh",
                    " ", { "Fn::GetAtt" : [ "ManagerInstance", "PublicIp" ] },
                    " ", { "Ref" : "DynamoDB" },
                    " ", { "Ref" : "AWS::Region" },
                    " 2>&1`\n",
                    "[ \"$result\" == \"\" ] || error_exit \"server_setup.sh failed, $result\"\n",
                    "# All is well so signal success\n",
                    "/opt/aws/bin/cfn-signal -e 0 -r \"server setup complete\" '", { "Ref" : "ServerWaitHandle" }, "'\n",
                    "reboot\n"
                    ] ] }
                }
            }
        },

        "ServerAutoScalingGroup" : {
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "Properties" : {
                "AvailabilityZones" : { "Fn::GetAZs" : "" },
                "LaunchConfigurationName" : { "Ref" : "ServerLaunchConfiguration" },
                "MinSize" : { "Ref" : "ServerInstanceNumber" },
                "MaxSize" : { "Ref" : "ServerInstanceNumber" },
                "DesiredCapacity" : { "Ref" : "ServerInstanceNumber" }
            }
        },

        "ServerWaitHandle" : {
            "Type" : "AWS::CloudFormation::WaitConditionHandle"
        },

        "ServerWaitCondition" : {
            "Type" : "AWS::CloudFormation::WaitCondition",
            "DependsOn" : "ServerAutoScalingGroup",
            "Properties" : {
                "Count" : { "Ref" : "ServerInstanceNumber" },
                "Handle" : { "Ref" : "ServerWaitHandle"},
                "Timeout" : "1200"
            }
        },
        "ClientLaunchConfiguration" : {
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "Properties" : {
                "KeyName" : { "Ref" : "KeyName" },
				"ImageId" : { "Fn::FindInMap" : [ "Region2Ami", { "Ref" : "AWS::Region" }, "AMI" ] },
                "SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
                "InstanceType" : { "Ref" : "ClientInstanceType"},
                "InstanceMonitoring" : "false",
                "IamInstanceProfile" : { "Ref" : "InstanceProfile" },
                "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
                    "#!/bin/bash", "\n",
                    "yum update -y\n",
                    "# Helper function\n",
                    "function error_exit\n",
                    "{\n",
                    "  /opt/aws/bin/cfn-signal -e 1 -r \"$1\" '", { "Ref" : "ClientWaitHandle" }, "'\n",
                    "  exit 1\n",
                    "}\n",
                    "cd /opt\n",
                    "wget ",
                    " ", { "Ref" : "ResourceLink" },
                    " 2>&1\n",
                    "filename=$(basename ", { "Ref" : "ResourceLink" }, ")\n",
                    "unzip $filename\n",
                    "cd ${filename%.*}\n",
                    "result=`./client_setup.sh",
                    " ", { "Fn::GetAtt" : [ "ManagerInstance", "PublicIp" ] },
                    " 2>&1`\n",
                    "[ \"$result\" == \"\" ] || error_exit \"client_setup.sh failed, $result\"\n",
                    "# All is well so signal success\n",
                    "/opt/aws/bin/cfn-signal -e 0 -r \"client setup complete\" '", { "Ref" : "ClientWaitHandle" }, "'\n",
                    "reboot\n"
                    ] ] }
                }
            }
        },

        "ClientAutoScalingGroup" : {
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "Properties" : {
                "AvailabilityZones" : { "Fn::GetAZs" : "" },
                "LaunchConfigurationName" : { "Ref" : "ClientLaunchConfiguration" },
                "MinSize" : { "Ref" : "ClientInstanceNumber" },
                "MaxSize" : { "Ref" : "ClientInstanceNumber" },
                "DesiredCapacity" : { "Ref" : "ClientInstanceNumber" }
            }
        },

        "ClientWaitHandle" : {
            "Type" : "AWS::CloudFormation::WaitConditionHandle"
        },

        "ClientWaitCondition" : {
            "Type" : "AWS::CloudFormation::WaitCondition",
            "DependsOn" : "ClientAutoScalingGroup",
            "Properties" : {
                "Count" : { "Ref" : "ClientInstanceNumber" },
                "Handle" : { "Ref" : "ClientWaitHandle"},
                "Timeout" : "1200"
            }
        },

        "ManagerInstance" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "KeyName" : { "Ref" : "KeyName" },
                "InstanceType" : { "Ref" : "ManagerInstanceType" },
                "SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
                "ImageId" : { "Fn::FindInMap" : [ "Region2Ami", { "Ref" : "AWS::Region" }, "AMI" ] },
                "IamInstanceProfile" : { "Ref" : "InstanceProfile" },
                "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
                    "#!/bin/bash", "\n",
                    "yum update -y\n",
                    "# Helper function\n",
                    "function error_exit\n",
                    "{\n",
                    "  /opt/aws/bin/cfn-signal -e 1 -r \"$1\" '", { "Ref" : "ManagerWaitHandle" }, "'\n",
                    "  exit 1\n",
                    "}\n",
                    "cd /opt\n",
                    "wget ",
                    " ", { "Ref" : "ResourceLink" },
                    " 2>&1\n",
                    "filename=$(basename ", { "Ref" : "ResourceLink" }, ")\n",
                    "unzip $filename\n",
                    "cd ${filename%.*}\n",
                    "result=`./manager_setup.sh",
                    " 2>&1`\n",
                    "[ \"$result\" == \"\" ] || error_exit \"manager_setup.sh failed, $result\"\n",
                    "# All is well so signal success\n",
                    "/opt/aws/bin/cfn-signal -e 0 -r \"manager setup complete\" '", { "Ref" : "ManagerWaitHandle" }, "'\n"
                    ] ] }
                }
            }
        },

        "ManagerWaitHandle" : {
            "Type" : "AWS::CloudFormation::WaitConditionHandle"
        },

        "ManagerWaitCondition" : {
            "Type" : "AWS::CloudFormation::WaitCondition",
            "DependsOn" : "ManagerInstance",
            "Properties" : {
                "Handle" : { "Ref" : "ManagerWaitHandle"},
                "Timeout" : "1200"
            }
        }
    }
}
